---
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    lib_dir: libs
css: styles.css
params: 
    title: "GRIN Epilepsy Trio Analysis!"
---
---
title: `r params$title`
---
```{r libs, echo=FALSE, message=FALSE, cache=FALSE, warning=FALSE, results='hide', fig.path='{{SLINK}}/'}
library(knitr)
library(DT)
library(plyr)
library(dplyr)
library(GenomicRanges)
library(SRAdb)
library(stringr)
library(reshape2)
options(digits = 2)
options(width=1200)
```

```{r functions, echo=FALSE, message=FALSE, cache=FALSE, warning=FALSE, results='hide', fig.path='{{SLINK}}/'}
## http://www.r-bloggers.com/identifying-records-in-data-frame-a-that-are-not-contained-in-data-frame-b-%E2%80%93-a-comparison/
commit <- system("git rev-parse --verify HEAD",intern=TRUE)

thisnotinthat <- function(x.1,x.2,...){
  x.1p <- do.call("paste", x.1)
  x.2p <- do.call("paste", x.2)
  x.1[! x.1p %in% x.2p, ]
}

viewDataTable <- function(dat){

  cols2crop <- grep('family_genotypes|ref|alt', colnames(dat))
  cols2hide <- grep('Description|Variants|Perc|chr|^pos$|rsid|^ref$|^alt$|^gene$|
                    impact_severity|rvis_score|depths|gt_quals|family_genotypes|denovo_prob|is_exonic|is_splicing|functiongvs|exac_ac_all',
                    colnames(dat), invert = TRUE)

  DT::datatable(dat,
                  escape = FALSE,
                extensions = c('Buttons'),
                selection = "single",
                filter = "bottom",
                options = list(
                  columnDefs = list(list(visible = FALSE, targets = cols2hide),
                                    list(targets = cols2crop, render = JS("function(data, type, row, meta) {", "return type === 'display' && data.length > 10 ?", "'<span title=\"' + data + '\">' + data.substr(0, 10) + '...</span>' : data;", "}"))),
                  dom = 'Bfrtip',
                  buttons = list('colvis','pageLength', 'copy','print',
                                 list(extend = "collection",
                                      buttons = c('csv', 'excel', 'pdf'),
                                      text = 'Download'
                                 )),
                  searchHighlight = TRUE,
                  lengthMenu = list(c(5, 10, 15, 20, 25, -1), c('5', '10', '15', '20', '25', 'All')),
                  initComplete = DT::JS("function(settings, json) {",
                                        "$(this.api().table().header()).css({'background-color': '#003366', 'color': '#fff'});",
                                        "}"),
                  scrollX = TRUE
                ))
}
```

## Filters
<blockquote>
We used the following filters to reduce the number of reported false positives:

1. Spurious inherited variants can often appear due to insufficient sequence coverage so the **mininum sequence depth** was set to **15**.

2. We are interested in mutations that are likely to have functional consequence so only variants with **Medium or High impact severity** were used.

3. **Minimum genotyping quality** per sample in the trio was set to **20**.

4. GL contigs were not used.

</blockquote>

## De novo analysis
<blockquote>
Genotype Requirements:
  
1. all affecteds must be het
2. all unaffected must be homref or homalt
3. at least 1 affected kid must have unaffected parents
4. if an affected has affected parents, itâ€™s not de_novo
5. all affected kids must have unaffected (or no) parents
6. warning if none of the affected samples have parents.
</blockquote>

<div class="panel panel-default">
<div class="panel-heading">
<h3 class="panel-title">Variant summary for de novo variants</h3>
</div>
<div class="panel-body">
This represents a brief summary of the de novo variants.

```{r denovo_summary, results='asis', warning = FALSE, echo=FALSE, message=FALSE, cache=FALSE,  fig.path='{{SLINK}}/'}

if(length(denovo) == 1 && denovo == 0)
{
  varcount <- 0
  showChunk <- FALSE
} else {
  showChunk <- TRUE
  dt <- plyr::count(denovo , 'impact_so')
  viewDataTable(dat = data.frame(Description = dt$impact_so, 
                                 Variants = dt$freq, 
                                 Perc = round(prop.table(dt$freq)*100,2)))
}
```

```{r denovo_igv, warnings = FALSE, echo=FALSE, message=FALSE, cache=FALSE,fig.path='{{SLINK}}/'}
denovo$variant_id<-paste("<a href=\"",paste(paste("../screenshots",paste(familyname,denovo$variant_id,'png',sep="."),sep="/")),"\">",denovo$variant_id,"</a>",sep="")
```

```{r denovo_rvis, warnings = FALSE, eval=showChunk, echo=FALSE, message=FALSE, cache=FALSE,fig.path='{{SLINK}}/'}
denovo$orig_chrom<-denovo$chrom
denovo$chrom <- sub('^chr','',denovo$chrom)
denovogear <- denovogear[-grep('^GL',denovogear$chr),]
denovogear$chr <- sub('^chr','',denovogear$chr)
denovo <- merge(denovo, rvis, by.x = "gene", by.y = "GENE", all.x = T, sort = F)
```

```{r denovo_pp, warnings = FALSE, eval=showChunk, echo=FALSE, message=FALSE, cache=FALSE,fig.path='{{SLINK}}/'}
gr1 <- with(denovo, GRanges(chrom, IRanges(start = start, end = end))) 
gr2 <- with(denovogear, GRanges(chr, IRanges(start = pos, end = pos)))
type1 <- findOverlaps(query = gr1, subject = gr2, type = 'any')
denovo$denovo_prob <- NA
denovo[queryHits(type1),'denovo_prob'] <- denovogear[subjectHits(type1),'pp_dnm']
denovo <- denovo[order(denovo$denovo_prob, decreasing = TRUE),]

denovo$start <- ifelse(denovo$end-denovo$start==1, denovo$end, paste0(denovo$start,'-',denovo$end))
colnames(denovo)[grep('chr|start|vcf_id', colnames(denovo))] <- c('chr','pos','rsid')
denovo$end <- NULL
denovo <- denovo[,c(2:16,1,17:ncol(denovo))]

chr <- c(1:22,'X','Y','MT')
denovo$chr <- factor(denovo$chr, levels = chr)
denovo <- denovo[order(denovo$chr),]
denovo$exac_ac_all[denovo$exac_ac_all=="None"] <- "-1"
denovo$exac_ac_all <- as.numeric(denovo$exac_ac_all)
```

```{r denovo_filtered_variants, warning = FALSE, eval=showChunk, echo=FALSE, message=FALSE, cache=FALSE,  fig.path='{{SLINK}}/'}
varcount <- length(unique(denovo$variant_id))
```

**There are `r varcount` de novo variants.**
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading">
<h3 class="panel-title">All de novo variants</h3>
</div>
<div class="panel-body">
These are all de novo variants

```{r denovo_all, eval=showChunk, warning = FALSE, echo=FALSE, message=FALSE, cache=FALSE,  fig.path='{{SLINK}}/'}
denovo.all <- denovo

varcount <- length(unique(denovo.all$variant_id))
if(varcount)
{
  viewDataTable(dat = denovo.all)
}
```
**There are a total of `r varcount` variants**
</div>
</div>


<div class="panel panel-default">
<div class="panel-heading">
<h3 class="panel-title">De novo variants for Ingo Helbig</h3>
</div>
<div class="panel-body">
These are all de novo variants that satisfy the following criteria:

1. Variant function must be frameshift/missense/unknown.
2. Exac Adjusted allele count must be 0 or unknown.
3. Denovogear posterior probability must be >=20%.
4. Should be exonic and splicing.

```{r denovo_filtered, eval=showChunk, warning = FALSE, echo=FALSE, message=FALSE, cache=FALSE,  fig.path='{{SLINK}}/'}
denovo.sub <- denovo
denovo.sub <- denovo.sub[which(denovo.sub$is_exonic==1 & denovo.sub$is_splicing==1),]
denovo.sub <- denovo.sub[which(denovo.sub$functiongvs == "frameshift" | denovo.sub$functiongvs == "missense" | denovo.sub$functiongvs == "None"),]
denovo.sub <- denovo.sub[which(denovo.sub$exac_ac_all == "-1" | denovo.sub$exac_ac_all == "0"),]
denovo.sub <- denovo.sub[which(denovo.sub$denovo_prob >= 0.20),]

varcount <- length(unique(denovo.sub$variant_id))
if(varcount)
{
  viewDataTable(dat = denovo.sub)
}
```
**There are `r varcount` filtered variants**
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading">
<h3 class="panel-title">De novo variants for Ingo Helbig (Enhanced)</h3>
</div>
<div class="panel-body">
These are all de novo variants that satisfy the following criteria:

1. Allelic ratio for proband between 0.20-0.80
2. Allelic ratio for mom and dad: 0

```{r denovo_filtered_enhancement, eval=showChunk, warning = FALSE, echo=FALSE, message=FALSE, cache=FALSE,  fig.path='{{SLINK}}/'}
denovo.sub <- denovo
alt_depths <- colsplit(gsub("\\s+"," ", str_trim(gsub('[[]|[]]|[.]',' ',denovo.sub$gt_alt_depths)))," ",c('mom','dad','kid'))
gt_depths <- colsplit(gsub("\\s+"," ", str_trim(gsub('[[]|[]]|[.]',' ',denovo.sub$gt_depths)))," ",c('mom','dad','kid'))
dp <- data.frame(mom = alt_depths[,1]/gt_depths[,1], dad = alt_depths[,2]/gt_depths[,2], proband = alt_depths[,3]/gt_depths[,3])
denovo.sub <- denovo.sub[which(dp$proband>0.20 & dp$proband<0.80 & dp$mom==0 & dp$dad==0),]
varcount <- length(unique(denovo.sub$variant_id))
if(varcount)
{
  viewDataTable(dat = denovo.sub)
}
```
**There are `r varcount` filtered variants**
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading">
<h3 class="panel-title">Triage 1: De novo variants in recurrent genes</h3>
</div>
<div class="panel-body">
These are variants found in the recurrent genes associated with recurrent mutations in epilepsy.

```{r denovo_recurrent, results='asis', warning = FALSE, eval=showChunk, echo=FALSE, message=FALSE, cache=FALSE,  fig.path='{{SLINK}}/'}
denovo %>% dplyr::filter(recurrent_genes != "None") -> in_recurrent 
varcount <- length(unique(in_recurrent$variant_id))
if(varcount)
{
  viewDataTable(dat = in_recurrent)
}
```
**There are `r varcount` de novo variants in recurrent genes.**

</div>
</div>

<div class="panel panel-default">
<div class="panel-heading">
<h3 class="panel-title">Triage 2: De novo variants in literature genes with low tolerance</h3>
</div>
<div class="panel-body">
These are the remaining variants cited in the literature genes cited in the existing literature. Many of the literature-cited genes are likely tolerant, so this list is further filtered to only genes with an RVIS "ALL_0.1." value of <= 0.

```{r denovo_literature, results='asis', warning = FALSE, eval=showChunk, echo=FALSE, message=FALSE, cache=FALSE,  fig.path='{{SLINK}}/'}
denovo %>% dplyr::filter(literature_genes != "None") %>% dplyr::filter(as.numeric(rvis_score)<=0) %>% thisnotinthat(in_recurrent) -> in_literature
varcount <- length(unique(in_literature$variant_id))
if(varcount)
{
  viewDataTable(dat = in_literature)
}
```
**There are `r varcount` remaining variants found in literature genes.**

</div>
</div>

<div class="panel panel-default">
<div class="panel-heading">
<h3 class="panel-title">Triage 3: De novo coding variants not in the above</h3>
</div>
<div class="panel-body">
These are remaining variants that are located in the coding sequence of at least one transcript.

```{r denovo_coding, eval=showChunk, warning = FALSE, echo=FALSE, message=FALSE, cache=FALSE,  fig.path='{{SLINK}}/'}
denovo %>% dplyr::filter(is_coding==1) %>% thisnotinthat(in_literature) -> codingonly
varcount <- length(unique(codingonly$variant_id))
if(varcount)
{
  viewDataTable(dat = codingonly)
}
```
**There are `r varcount` remaining variants found in coding genes**
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading">
<h3 class="panel-title">Other de novo variants</h3>
</div>
<div class="panel-body">
These are the remaining de novo variants

```{r denovo_others, eval=showChunk, warning = FALSE, echo=FALSE, message=FALSE, cache=FALSE,  fig.path='{{SLINK}}/'}
others <- thisnotinthat(denovo, in_literature)
others <- thisnotinthat(others, codingonly)

varcount <- length(unique(others$variant_id))
if(varcount)
{
  viewDataTable(dat = others)
}
```
**There are `r varcount` remaining variants**
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading">
<h3 class="panel-title">Meta</h3>
</div>
<div style="color:#003366;", class="panel-body">
Git commit: **`r commit`**
</div>
</div>
